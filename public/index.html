<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.png" type="image/png">
  <title>Presupuestos</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.5rem 1.5rem 3rem;
      color: #1e293b;
      background: linear-gradient(to bottom, #eef2f6 0%, #e2e8f0 100%);
      min-height: 100vh;
    }
    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: #0f172a;
      letter-spacing: -0.02em;
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
    .section-card {
      background: #fff;
      border-radius: 10px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
      border-left: 4px solid #3b82f6;
    }
    .section-card.vehiculo { border-left-color: #0ea5e9; }
    .section-card.repuestos { border-left-color: #22c55e; }
    .section-card.mano { border-left-color: #f59e0b; }
    .section-card h2 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 1rem 0;
      color: #334155;
    }
    .section-card h2 .section-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      flex-shrink: 0;
      color: #3b82f6;
    }
    .section-card.vehiculo h2 .section-icon { color: #0ea5e9; }
    .section-card.repuestos h2 .section-icon { color: #22c55e; }
    .section-card.mano h2 .section-icon { color: #f59e0b; }
    .section-card h2 .section-icon svg {
      width: 100%;
      height: 100%;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem 1rem;
    }
    .form-grid label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.3rem;
      font-size: 0.875rem;
      color: #475569;
    }
    .form-grid input {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: border-color 0.15s, box-shadow 0.15s;
      text-transform: uppercase;
    }
    .segmented {
      display: flex;
      gap: 4px;
      padding: 2px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #f1f5f9;
      align-items: stretch;
      width: 100%;
      height: 38px; /* igualar altura visual de inputs */
    }
    .segmented-option {
      flex: 1 1 0;
      position: relative;
      cursor: pointer;
      user-select: none;
    }
    .segmented-option input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    .segmented-option span {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 0 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 700;
      color: #334155;
      transition: background 0.12s ease, box-shadow 0.12s ease, color 0.12s ease, transform 0.12s ease, border-color 0.12s ease;
      border: 1px solid transparent;
    }
    .segmented-option:hover span {
      color: #0f172a;
      transform: translateY(-1px);
    }
    .segmented-option input:checked + span {
      background: #ffffff;
      color: #0f172a;
      border-color: rgba(37, 99, 235, 0.45);
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
      transform: translateY(0);
    }
    .segmented-option input:focus-visible + span {
      outline: 3px solid rgba(59, 130, 246, 0.25);
      outline-offset: 2px;
    }
    .form-grid input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    .form-grid input[type="number"] { text-align: right; }
    .form-grid .full { grid-column: 1 / -1; }
    table {
      width: 100%;
      min-width: 520px;
      border-collapse: collapse;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.5rem 0.6rem;
      border: 1px solid #e2e8f0;
      text-align: left;
    }
    th {
      background: #f8fafc;
      font-weight: 600;
      color: #475569;
    }
    td input {
      width: 100%;
      padding: 0.45rem 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 5px;
      font-size: 0.875rem;
      text-transform: uppercase;
    }
    td input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    td input[type="number"] { text-align: right; }
    .col-valor-cell {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .col-valor-cell .valor-prefix {
      color: #475569;
      font-weight: 500;
      flex-shrink: 0;
    }
    .col-valor-cell input {
      text-align: right;
      min-width: 0;
    }
    .table-scroll-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }
    .table-scroll-wrap table {
      margin-bottom: 0;
    }
    .col-desc { width: 50%; min-width: 180px; }
    .col-cant { width: 10%; min-width: 72px; text-align: right; }
    .col-valor { width: 14%; min-width: 88px; text-align: right; }
    .col-total { width: 14%; min-width: 88px; text-align: right; }
    .col-del { width: 6%; min-width: 48px; text-align: center; }
    .col-total-cell { text-align: right; font-weight: 500; color: #334155; }
    .btn-row {
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
      cursor: pointer;
      background: #ef4444;
      color: #fff;
      border: none;
      border-radius: 5px;
    }
    .btn-row:hover { background: #dc2626; }
    .btn-del-row {
      width: 34px;
      height: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      cursor: pointer;
      background: #ef4444;
      color: #fff;
      border: none;
      border-radius: 8px;
    }
    .btn-del-row:hover { background: #dc2626; }
    .btn-del-row svg { width: 18px; height: 18px; }
    .btn-add {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      cursor: pointer;
      background: #22c55e;
      color: #fff;
      border: none;
      border-radius: 6px;
      margin-top: 0.25rem;
    }
    .btn-add:hover { background: #16a34a; }
    .btn-pdf {
      width: 100%;
      flex: 1 1 0;
      margin: 0;
      min-height: 52px;
      padding: 0.9rem 1.1rem;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }
    .btn-pdf:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.35);
      transform: translateY(-1px);
    }
    .btn-pdf:active { transform: translateY(0); filter: brightness(0.98); }
    .btn-pdf:disabled { opacity: 0.6; cursor: not-allowed; }
    .actions-row {
      width: 100%;
      max-width: 1280px;
      margin: 1.5rem auto 0;
      display: flex;
      gap: 0.75rem;
      align-items: stretch;
      justify-content: space-between;
    }
    @media (max-width: 700px) {
      .actions-row { flex-direction: column; }
    }
    .btn-retomar {
      width: 100%;
      flex: 1 1 0;
      margin: 0;
      min-height: 52px;
      padding: 0.9rem 1.1rem;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(6, 182, 212, 0.25);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }
    .btn-retomar:hover {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
      box-shadow: 0 4px 8px rgba(6, 182, 212, 0.3);
      transform: translateY(-1px);
    }
    .btn-retomar:active { transform: translateY(0); filter: brightness(0.98); }
    .btn-retomar:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-pdf svg, .btn-retomar svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      opacity: 0.95;
    }
    .message-wrap { margin-top: 1rem; }
    .error {
      padding: 0.75rem 1rem;
      background: #fef2f2;
      color: #b91c1c;
      border-radius: 8px;
      font-size: 0.9rem;
      border: 1px solid #fecaca;
    }
    .success {
      padding: 0.75rem 1rem;
      background: #f0fdf4;
      color: #166534;
      border-radius: 8px;
      font-size: 0.9rem;
      border: 1px solid #bbf7d0;
    }
    .presupuesto-num-wrap {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .presupuesto-num-wrap label {
      font-weight: 600;
      color: #334155;
      white-space: nowrap;
    }
    .presupuesto-num-wrap input {
      max-width: 9rem;
      padding: 0.45rem 0.55rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.9rem;
      text-transform: uppercase;
    }
    .presupuesto-num-wrap input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    .header-logo {
      text-align: center;
      padding: 0;
      margin: 0 0 0.5rem 0;
    }
    .header-logo img {
      max-height: 220px;
      width: auto;
      display: inline-block;
      vertical-align: top;
    }
    .presupuesto-num-wrap {
      justify-content: center;
    }
    .total-preview {
      font-weight: 700;
      color: #0f172a;
      white-space: nowrap;
    }
    .total-preview span {
      font-weight: 600;
      color: #334155;
      margin-right: 0.35rem;
    }
    .total-preview .total-amount {
      font-size: 1.15rem;
      letter-spacing: -0.01em;
    }
    .discounts-wrap {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 100%;
      max-width: 1280px;
      margin: 0 auto 0.75rem;
    }
    .discounts-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      padding: 0 0.25rem;
    }
    .discounts-extras {
      display: grid;
      grid-template-columns: 3fr 7fr;
      gap: 0.75rem;
      padding: 0 0.25rem;
    }
    @media (max-width: 700px) {
      .discounts-extras { grid-template-columns: 1fr; }
    }
    .discounts-extras label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.3rem;
      font-size: 0.875rem;
      color: #475569;
    }
    .discounts-extras input {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.9rem;
      text-align: right;
      text-transform: uppercase;
    }
    .discounts-extras input.note-input { text-align: left; text-transform: none; }
    .discounts-extras input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    .discounts-header .total-label {
      font-weight: 600;
      color: #334155;
    }
    .discounts-header .total-amount {
      font-size: 1.3rem;
      font-weight: 800;
      color: #0f172a;
    }
    .btn-secondary {
      padding: 0.45rem 0.85rem;
      font-size: 0.9rem;
      cursor: pointer;
      background: #0ea5e9;
      color: #fff;
      border: none;
      border-radius: 8px;
    }
    .btn-secondary:hover { background: #0284c7; }
    .discount-row {
      display: grid;
      grid-template-columns: 180px 1fr 48px;
      gap: 0.6rem;
      align-items: end;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 0.75rem 0.9rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    @media (max-width: 700px) {
      .discount-row { grid-template-columns: 1fr; }
    }
    .discount-row label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.3rem;
      font-size: 0.875rem;
      color: #475569;
    }
    .discount-row input {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.9rem;
      text-transform: uppercase;
    }
    .discount-row input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    .discount-row .btn-del-row {
      justify-self: center;
      align-self: end;
    }
  </style>
</head>
<body>
  <header class="header-logo">
    <img src="logo.png" alt="Logo" width="220" height="220">
  </header>

  <div class="presupuesto-num-wrap">
    <label for="presupuesto-num">Presupuesto Nº</label>
    <input type="text" id="presupuesto-num" value="">
  </div>

  <!-- Fila 1: Cliente (izq) | Vehículo (der) -->
  <div class="layout">
    <section class="section-card">
      <h2>
        <span class="section-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </span>
        Datos del Cliente
      </h2>
      <div class="form-grid">
        <div>
          <label for="cliente-nombre">Nombre</label>
          <input type="text" id="cliente-nombre" value="">
        </div>
        <div>
          <label for="cliente-fecha">Fecha</label>
          <input type="date" id="cliente-fecha" value="">
        </div>
        <div>
          <label for="cliente-rut">Rut</label>
          <input type="text" id="cliente-rut" value="">
        </div>
        <div>
          <label for="cliente-fono">Fono</label>
          <input type="text" id="cliente-fono" value="">
        </div>
      </div>
    </section>

    <section class="section-card vehiculo">
      <h2>
        <span class="section-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 16H9m10 0h3v-3.15a1 1 0 0 0-.84-.99L16 11l-2.7-3.6a1 1 0 0 0-.8-.4H8.24a1 1 0 0 0-.8.4L4.84 11l-5.16.86a1 1 0 0 0-.84.99V16h3"/><circle cx="17.5" cy="17.5" r="2.5"/><circle cx="7.5" cy="17.5" r="2.5"/></svg>
        </span>
        Datos del Vehículo
      </h2>
      <div class="form-grid">
        <div>
          <label for="vehiculo-patente">Patente</label>
          <input type="text" id="vehiculo-patente" value="">
        </div>
        <div>
          <label for="vehiculo-ano">Año</label>
          <input type="text" id="vehiculo-ano" value="">
        </div>
        <div>
          <label for="vehiculo-marca">Marca</label>
          <input type="text" id="vehiculo-marca" value="">
        </div>
        <div>
          <label for="vehiculo-modelo">Modelo</label>
          <input type="text" id="vehiculo-modelo" value="">
        </div>
        <div>
          <label for="vehiculo-vin">VIN</label>
          <input type="text" id="vehiculo-vin" value="">
        </div>
        <div>
          <label for="vehiculo-kilometraje">Kilometraje</label>
          <input type="text" id="vehiculo-kilometraje" value="">
        </div>
        <div>
          <label>Combustible</label>
          <div class="segmented" role="radiogroup" aria-label="Combustible">
            <label class="segmented-option">
              <input type="radio" name="vehiculo-combustible" value="DIESEL">
              <span>Diesel</span>
            </label>
            <label class="segmented-option">
              <input type="radio" name="vehiculo-combustible" value="BENCINA">
              <span>Bencina</span>
            </label>
          </div>
        </div>
        <div>
          <label for="vehiculo-color">Color</label>
          <input type="text" id="vehiculo-color" value="">
        </div>
      </div>
    </section>
  </div>

  <!-- Tablas una arriba de la otra -->
  <section class="section-card repuestos">
    <h2>
      <span class="section-icon" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
      </span>
      Repuestos
    </h2>
    <div class="table-scroll-wrap">
      <table id="tabla-repuestos">
        <thead>
          <tr>
            <th class="col-desc">Descripción</th>
            <th class="col-cant">Cantidad</th>
            <th class="col-valor">Valor</th>
            <th class="col-total">Total</th>
            <th class="col-del"></th>
          </tr>
        </thead>
        <tbody id="body-repuestos"></tbody>
      </table>
    </div>
    <button type="button" class="btn-add" id="add-repuesto">+ Añadir fila</button>
  </section>

  <section class="section-card mano">
    <h2>
      <span class="section-icon" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
      </span>
      Mano de Obra
    </h2>
    <div class="table-scroll-wrap">
      <table id="tabla-mano">
        <thead>
          <tr>
            <th class="col-desc">Descripción</th>
            <th class="col-cant">Cantidad</th>
            <th class="col-valor">Valor</th>
            <th class="col-total">Total</th>
            <th class="col-del"></th>
          </tr>
        </thead>
        <tbody id="body-mano"></tbody>
      </table>
    </div>
    <button type="button" class="btn-add" id="add-mano">+ Añadir fila</button>
  </section>

  <section class="discounts-wrap" aria-label="Descuentos y total">
    <div class="discounts-header">
      <div class="total-preview">
        <span class="total-label">Total:</span>
        <strong id="total-preview" class="total-amount">$ 0</strong>
      </div>
      <button type="button" class="btn-secondary" id="btn-add-descuento">Añadir descuento</button>
    </div>
    <div id="discounts-list"></div>
    <div class="discounts-extras" aria-label="Abono y nota">
      <div>
        <label for="abono-monto">Abono (opcional)</label>
        <input type="text" id="abono-monto" value="" inputmode="numeric" data-raw="0">
      </div>
      <div>
        <label for="nota">Nota (opcional)</label>
        <input type="text" id="nota" value="" class="note-input">
      </div>
    </div>
  </section>

  <div class="actions-row">
    <button type="button" class="btn-retomar" id="btn-retomar">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M21 12a9 9 0 1 1-3-6.7"/>
        <polyline points="21 3 21 9 15 9"/>
      </svg>
      Retomar Orden
    </button>
    <button type="button" class="btn-pdf" id="btn-pdf">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <line x1="8" y1="13" x2="16" y2="13"/>
        <line x1="8" y1="17" x2="16" y2="17"/>
      </svg>
      Generar PDF
    </button>
  </div>
  <input type="file" id="file-retomar" accept="application/pdf" style="display:none;">
  <div id="message" class="message-wrap"></div>

  <script>
    const bodyRepuestos = document.getElementById('body-repuestos');
    const bodyMano = document.getElementById('body-mano');
    const addRepuesto = document.getElementById('add-repuesto');
    const addMano = document.getElementById('add-mano');
    const btnPdf = document.getElementById('btn-pdf');
    const btnRetomar = document.getElementById('btn-retomar');
    const fileRetomar = document.getElementById('file-retomar');
    const message = document.getElementById('message');
    const totalPreviewEl = document.getElementById('total-preview');
    const btnAddDescuento = document.getElementById('btn-add-descuento');
    const discountsList = document.getElementById('discounts-list');
    const abonoMontoInput = document.getElementById('abono-monto');
    const notaInput = document.getElementById('nota');
    const presupuestoNumInput = document.getElementById('presupuesto-num');

    const LS_LAST_PRESUPUESTO = 'presupuestos:lastGeneratedPresupuesto';
    const LS_SKIP_NEXT_INCREMENT = 'presupuestos:skipNextPresupuestoIncrement';

    function formatMiles(val) {
      var n = parseInt(String(val).replace(/\D/g, ''), 10);
      if (isNaN(n)) return '';
      return n.toLocaleString('es-CL');
    }
    function parseValor(str) {
      var n = parseInt(String(str).replace(/\D/g, ''), 10);
      return isNaN(n) ? 0 : n;
    }

    function forceUppercaseInput(inputEl) {
      if (!inputEl) return;
      // Nota final queda fuera (clase note-input)
      if (inputEl.classList && inputEl.classList.contains('note-input')) return;
      function applyUpper() {
        var v = String(inputEl.value || '');
        var up = v.toUpperCase();
        if (v === up) return;
        var start = inputEl.selectionStart;
        var end = inputEl.selectionEnd;
        inputEl.value = up;
        try {
          if (typeof start === 'number' && typeof end === 'number') inputEl.setSelectionRange(start, end);
        } catch (_) {}
      }
      inputEl.addEventListener('input', applyUpper);
      inputEl.addEventListener('blur', applyUpper);
      applyUpper();
    }

    (function initFechaHoy() {
      var fechaInput = document.getElementById('cliente-fecha');
      if (!fechaInput || fechaInput.type !== 'date') return;
      if (String(fechaInput.value || '').trim() !== '') return;
      var d = new Date();
      var yyyy = d.getFullYear();
      var mm = String(d.getMonth() + 1).padStart(2, '0');
      var dd = String(d.getDate()).padStart(2, '0');
      fechaInput.value = yyyy + '-' + mm + '-' + dd;
    })();

    // Forzar MAYÚSCULAS en campos estáticos (excepto Nota)
    forceUppercaseInput(presupuestoNumInput);
    forceUppercaseInput(document.getElementById('cliente-nombre'));
    forceUppercaseInput(document.getElementById('cliente-rut'));
    forceUppercaseInput(document.getElementById('cliente-fono'));
    forceUppercaseInput(document.getElementById('vehiculo-patente'));
    forceUppercaseInput(document.getElementById('vehiculo-ano'));
    forceUppercaseInput(document.getElementById('vehiculo-marca'));
    forceUppercaseInput(document.getElementById('vehiculo-modelo'));
    forceUppercaseInput(document.getElementById('vehiculo-vin'));
    forceUppercaseInput(document.getElementById('vehiculo-color'));

    function incrementPresupuestoString(raw) {
      var s = String(raw || '').trim();
      if (!s) return '';
      // Mantener solo dígitos; preservar largo para ceros a la izquierda
      var digits = s.replace(/\D/g, '');
      if (!digits) return '';
      var width = digits.length;
      var n = parseInt(digits, 10);
      if (isNaN(n)) return '';
      var next = String(n + 1);
      if (next.length < width) next = next.padStart(width, '0');
      return next;
    }

    (function initPresupuestoAutoincrement() {
      if (!presupuestoNumInput) return;
      // Si lo último fue una orden retomada, no autoincrementar esta vez.
      var skip = localStorage.getItem(LS_SKIP_NEXT_INCREMENT);
      if (skip === '1') {
        localStorage.removeItem(LS_SKIP_NEXT_INCREMENT);
        return;
      }
      // Solo autocompletar si está vacío (no pisar lo que el usuario escribió).
      if (String(presupuestoNumInput.value || '').trim() !== '') return;
      var last = localStorage.getItem(LS_LAST_PRESUPUESTO) || '';
      var next = incrementPresupuestoString(last);
      if (next) presupuestoNumInput.value = next;
    })();

    function initOptionalMontoInput(inputEl) {
      if (!inputEl) return;
      function formatIt() {
        var v = parseValor(inputEl.value);
        inputEl.dataset.raw = v;
        inputEl.value = v === 0 ? '' : formatMiles(v);
      }
      inputEl.addEventListener('input', formatIt);
      inputEl.addEventListener('blur', formatIt);
      inputEl.dataset.raw = '0';
    }
    initOptionalMontoInput(abonoMontoInput);

    var descuentoRowCounter = 0;

    function normalizeKey(s) {
      var str = String(s || '').trim().toLowerCase();
      try {
        str = str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      } catch (_) {}
      return str.replace(/\s+/g, ' ');
    }

    function getRepuestosCatalogo() {
      var out = [];
      bodyRepuestos.querySelectorAll('tr').forEach(function(tr) {
        var descEl = tr.querySelector('input[name="desc"]');
        var desc = descEl ? descEl.value.trim() : '';
        if (!desc) return;
        var cantEl = tr.querySelector('input[name="cant"]');
        var cant = parseInt(cantEl ? cantEl.value : '0', 10) || 0;
        var valorEl = tr.querySelector('input[name="valor"]');
        var valorUnit = valorEl && valorEl.dataset.raw !== undefined ? parseInt(valorEl.dataset.raw, 10) : parseValor(valorEl ? valorEl.value : '');
        if (isNaN(valorUnit)) valorUnit = 0;
        var total = cant * valorUnit;
        out.push({ descripcion: desc, total: total });
      });
      return out;
    }

    function getRepuestoTotalByDescripcion(desc) {
      var key = normalizeKey(desc);
      if (!key) return 0;
      var catalogo = getRepuestosCatalogo();
      return catalogo.reduce(function(s, it) {
        if (normalizeKey(it.descripcion) === key) return s + (it.total || 0);
        return s;
      }, 0);
    }

    function getRepuestosUnicos() {
      var seen = {};
      var list = [];
      getRepuestosCatalogo().forEach(function(it) {
        var k = normalizeKey(it.descripcion);
        if (!k || seen[k]) return;
        seen[k] = true;
        list.push(it.descripcion);
      });
      return list;
    }

    function updateMotivoDatalist(datalistEl, query) {
      if (!datalistEl) return;
      var q = normalizeKey(query);
      var items = getRepuestosUnicos();
      if (q) {
        items = items
          .map(function(t) {
            var nk = normalizeKey(t);
            var idx = nk.indexOf(q);
            return { t: t, score: idx === -1 ? 9999 : idx };
          })
          .filter(function(o) { return o.score !== 9999; })
          .sort(function(a, b) { return a.score - b.score; })
          .slice(0, 10)
          .map(function(o) { return o.t; });
      } else {
        items = items.slice(0, 10);
      }
      datalistEl.innerHTML = items.map(function(t) { return '<option value="' + t.replace(/"/g, '&quot;') + '"></option>'; }).join('');
    }

    function crearDescuentoRow() {
      descuentoRowCounter += 1;
      var row = document.createElement('div');
      row.className = 'discount-row';
      var datalistId = 'repuestos-suggestions-' + descuentoRowCounter;
      row.innerHTML =
        '<div>' +
          '<label>Descuento (monto)</label>' +
          '<input type="text" class="descuento-monto" placeholder="0" inputmode="numeric" data-raw="0">' +
        '</div>' +
        '<div>' +
          '<label>Motivo <span style="font-weight:500;color:#64748b;">(opcional)</span></label>' +
          '<input type="text" class="descuento-motivo" placeholder="Ej. Termostato (opcional)" list="' + datalistId + '">' +
          '<datalist id="' + datalistId + '"></datalist>' +
        '</div>' +
        '<div>' +
          '<label>&nbsp;</label>' +
          '<button type="button" class="btn-del-row btn-del-descuento" title="Eliminar descuento" aria-label="Eliminar descuento">' +
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">' +
              '<polyline points="3 6 5 6 21 6"></polyline>' +
              '<path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>' +
              '<path d="M10 11v6"></path>' +
              '<path d="M14 11v6"></path>' +
              '<path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>' +
            '</svg>' +
          '</button>' +
        '</div>';

      var montoInput = row.querySelector('.descuento-monto');
      var motivoInput = row.querySelector('.descuento-motivo');
      var delBtn = row.querySelector('.btn-del-descuento');
      var datalistEl = row.querySelector('#' + datalistId);

      forceUppercaseInput(motivoInput);

      function formatMonto() {
        var v = parseValor(montoInput.value);
        montoInput.dataset.raw = v;
        montoInput.value = v === 0 ? '' : formatMiles(v);
        actualizarTotalPreview();
      }

      montoInput.addEventListener('input', formatMonto);
      montoInput.addEventListener('blur', formatMonto);
      motivoInput.addEventListener('input', function() {
        updateMotivoDatalist(datalistEl, motivoInput.value);
        actualizarTotalPreview();
      });
      motivoInput.addEventListener('blur', function() {
        updateMotivoDatalist(datalistEl, motivoInput.value);
        // Si el motivo coincide con un repuesto, sugerimos el monto (solo si aún no hay monto)
        var motivo = motivoInput.value.trim().toUpperCase();
        var repTotal = getRepuestoTotalByDescripcion(motivo);
        var curr = montoInput && montoInput.dataset.raw !== undefined ? parseInt(montoInput.dataset.raw, 10) : 0;
        if ((isNaN(curr) || curr <= 0) && repTotal > 0) {
          montoInput.dataset.raw = repTotal;
          montoInput.value = formatMiles(repTotal);
        }
        actualizarTotalPreview();
      });
      delBtn.addEventListener('click', function() {
        row.remove();
        actualizarTotalPreview();
      });

      // Inicializar sugerencias con repuestos actuales
      updateMotivoDatalist(datalistEl, '');
      return row;
    }

    if (btnAddDescuento && discountsList) {
      btnAddDescuento.addEventListener('click', function() {
        discountsList.appendChild(crearDescuentoRow());
      });
    }

    function leerDescuentos() {
      var out = [];
      if (!discountsList) return out;
      discountsList.querySelectorAll('.discount-row').forEach(function(row) {
        var montoEl = row.querySelector('.descuento-monto');
        var motivoEl = row.querySelector('.descuento-motivo');
        var monto = montoEl && montoEl.dataset.raw !== undefined ? parseInt(montoEl.dataset.raw, 10) : 0;
        if (isNaN(monto) || monto < 0) monto = 0;
        var motivo = motivoEl ? motivoEl.value.trim().toUpperCase() : '';
        if (monto > 0) out.push({ monto: monto, motivo: motivo });
      });
      return out;
    }

    function calcularSubtotal() {
      function sumarTbody(tbody) {
        var sum = 0;
        tbody.querySelectorAll('tr').forEach(function(tr) {
          var descEl = tr.querySelector('input[name="desc"]');
          var desc = descEl ? descEl.value.trim() : '';
          var cantEl = tr.querySelector('input[name="cant"]');
          var cant = parseInt(cantEl ? cantEl.value : '0', 10) || 0;
          var valorEl = tr.querySelector('input[name="valor"]');
          var valorUnit = valorEl && valorEl.dataset.raw !== undefined ? parseInt(valorEl.dataset.raw, 10) : parseValor(valorEl ? valorEl.value : '');
          if (isNaN(valorUnit)) valorUnit = 0;
          var total = cant * valorUnit;
          if (desc && total > 0) sum += total;
        });
        return sum;
      }
      return sumarTbody(bodyRepuestos) + sumarTbody(bodyMano);
    }

    function actualizarTotalPreview() {
      if (!totalPreviewEl) return;
      var subtotal = calcularSubtotal();
      var descuentos = leerDescuentos();
      var descuentoTotal = descuentos.reduce(function(s, d) { return s + (d.monto || 0); }, 0);
      if (descuentoTotal > subtotal) descuentoTotal = subtotal;
      var total = subtotal - descuentoTotal;
      totalPreviewEl.textContent = '$ ' + formatMiles(total);
    }

    function actualizarTotalFila(tr) {
      var cant = parseInt(tr.querySelector('input[name="cant"]').value, 10) || 0;
      var valorEl = tr.querySelector('input[name="valor"]');
      var valorUnit = valorEl && valorEl.dataset.raw !== undefined ? parseInt(valorEl.dataset.raw, 10) : parseValor(valorEl ? valorEl.value : '');
      if (isNaN(valorUnit)) valorUnit = 0;
      var total = cant * valorUnit;
      var totalCell = tr.querySelector('.col-total-cell');
      if (totalCell) totalCell.textContent = total === 0 ? '' : '$ ' + formatMiles(total);
      actualizarTotalPreview();
    }

    function filaTabla() {
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td class="col-desc"><input type="text" name="desc"></td>' +
        '<td class="col-cant"><input type="number" name="cant" min="0" value="1" placeholder="0"></td>' +
        '<td class="col-valor"><div class="col-valor-cell"><span class="valor-prefix">$</span><input type="text" name="valor" placeholder="0" data-raw="0"></div></td>' +
        '<td class="col-total-cell" tabindex="-1" aria-readonly="true"></td>' +
        '<td class="col-del">' +
          '<button type="button" class="btn-del-row" title="Eliminar fila" aria-label="Eliminar fila">' +
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">' +
              '<polyline points="3 6 5 6 21 6"></polyline>' +
              '<path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>' +
              '<path d="M10 11v6"></path>' +
              '<path d="M14 11v6"></path>' +
              '<path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>' +
            '</svg>' +
          '</button>' +
        '</td>';
      var cantInput = tr.querySelector('input[name="cant"]');
      var valorInput = tr.querySelector('input[name="valor"]');
      var descInput = tr.querySelector('input[name="desc"]');
      forceUppercaseInput(descInput);
      valorInput.addEventListener('input', function() {
        var v = parseValor(this.value);
        this.dataset.raw = v;
        this.value = v === 0 ? '' : formatMiles(v);
        actualizarTotalFila(tr);
      });
      valorInput.addEventListener('blur', function() {
        var v = parseValor(this.value);
        this.dataset.raw = v;
        this.value = v === 0 ? '' : formatMiles(v);
        actualizarTotalFila(tr);
      });
      cantInput.addEventListener('input', function() { actualizarTotalFila(tr); });
      cantInput.addEventListener('change', function() { actualizarTotalFila(tr); });
      if (descInput) {
        descInput.addEventListener('input', function() { actualizarTotalPreview(); });
        descInput.addEventListener('blur', function() { actualizarTotalPreview(); });
      }
      tr.querySelector('.btn-del-row').addEventListener('click', function() { tr.remove(); actualizarTotalPreview(); });
      actualizarTotalFila(tr);
      return tr;
    }

    function addFila(tbody) { tbody.appendChild(filaTabla()); }
    addRepuesto.addEventListener('click', function() { addFila(bodyRepuestos); });
    addMano.addEventListener('click', function() { addFila(bodyMano); });

    (function initKilometraje() {
      var kmInput = document.getElementById('vehiculo-kilometraje');
      if (!kmInput) return;
      function formatKm() {
        var v = parseValor(kmInput.value);
        kmInput.dataset.raw = v;
        kmInput.value = v === 0 ? '' : formatMiles(v);
      }
      kmInput.addEventListener('input', formatKm);
      kmInput.addEventListener('blur', formatKm);
    })();

    var row0Rep = filaTabla();
    row0Rep.querySelector('input[name="valor"]').value = '';
    row0Rep.querySelector('input[name="valor"]').dataset.raw = '0';
    actualizarTotalFila(row0Rep);
    bodyRepuestos.appendChild(row0Rep);
    var row0Mano = filaTabla();
    row0Mano.querySelector('input[name="valor"]').value = '';
    row0Mano.querySelector('input[name="valor"]').dataset.raw = '0';
    actualizarTotalFila(row0Mano);
    bodyMano.appendChild(row0Mano);
    actualizarTotalPreview();

    function leerFilas(tbody) {
      var items = [];
      tbody.querySelectorAll('tr').forEach(function(tr) {
        var desc = tr.querySelector('input[name="desc"]').value.trim().toUpperCase();
        var cant = parseInt(tr.querySelector('input[name="cant"]').value, 10) || 0;
        var valorEl = tr.querySelector('input[name="valor"]');
        var valorUnit = valorEl && valorEl.dataset.raw !== undefined ? parseInt(valorEl.dataset.raw, 10) : parseValor(valorEl ? valorEl.value : '');
        if (isNaN(valorUnit)) valorUnit = 0;
        var valorTotal = cant * valorUnit;
        if (desc && valorTotal > 0) items.push({ descripcion: desc, cantidad: cant, valor: valorTotal, valorUnitario: valorUnit });
      });
      return items;
    }

    function formatFechaParaPdf(isoDate) {
      if (!isoDate) return '';
      var d = new Date(isoDate + 'T12:00:00');
      var day = String(d.getDate()).padStart(2, '0');
      var month = String(d.getMonth() + 1).padStart(2, '0');
      var year = d.getFullYear();
      return day + '/' + month + '/' + year;
    }

    function leerCliente() {
      var fechaInput = document.getElementById('cliente-fecha');
      var fechaValue = fechaInput.type === 'date' ? formatFechaParaPdf(fechaInput.value) : fechaInput.value.trim();
      return {
        nombre: document.getElementById('cliente-nombre').value.trim().toUpperCase(),
        fecha: fechaValue,
        rut: document.getElementById('cliente-rut').value.trim().toUpperCase(),
        fono: document.getElementById('cliente-fono').value.trim().toUpperCase(),
      };
    }
    function leerVehiculo() {
      var kmInput = document.getElementById('vehiculo-kilometraje');
      var kilometraje = kmInput.value.trim() === ''
        ? ''
        : (kmInput.dataset.raw !== undefined && kmInput.dataset.raw !== '' ? String(kmInput.dataset.raw) : String(parseValor(kmInput.value)));
      var combSel = document.querySelector('input[name="vehiculo-combustible"]:checked');
      var combustible = combSel ? String(combSel.value || '').trim().toUpperCase() : '';
      return {
        patente: document.getElementById('vehiculo-patente').value.trim().toUpperCase(),
        ano: document.getElementById('vehiculo-ano').value.trim().toUpperCase(),
        marca: document.getElementById('vehiculo-marca').value.trim().toUpperCase(),
        modelo: document.getElementById('vehiculo-modelo').value.trim().toUpperCase(),
        kilometraje: kilometraje,
        vin: document.getElementById('vehiculo-vin').value.trim().toUpperCase(),
        combustible: combustible,
        color: document.getElementById('vehiculo-color').value.trim().toUpperCase(),
      };
    }

    function showMessage(text, isError) {
      message.innerHTML = '<div class="' + (isError ? 'error' : 'success') + '">' + text + '</div>';
    }

    function arrayBufferToBase64(buffer) {
      var binary = '';
      var bytes = new Uint8Array(buffer);
      var len = bytes.byteLength;
      for (var i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
      return btoa(binary);
    }

    function setMoneyInput(inputEl, amount) {
      if (!inputEl) return;
      var v = parseInt(amount, 10) || 0;
      if (v < 0) v = 0;
      inputEl.dataset.raw = String(v);
      inputEl.value = v === 0 ? '' : formatMiles(v);
    }

    function clearTbody(tbody) {
      while (tbody.firstChild) tbody.removeChild(tbody.firstChild);
    }

    function setTablaDesdeItems(tbody, items) {
      clearTbody(tbody);
      (items || []).forEach(function(it) {
        var tr = filaTabla();
        var descInput = tr.querySelector('input[name="desc"]');
        var cantInput = tr.querySelector('input[name="cant"]');
        var valorInput = tr.querySelector('input[name="valor"]');
        if (descInput) descInput.value = String((it && it.descripcion) || '').trim().toUpperCase();
        if (cantInput) cantInput.value = String(parseInt(it && it.cantidad, 10) || 1);
        var unit = parseInt(it && it.valorUnitario, 10);
        if (isNaN(unit) || unit < 0) unit = 0;
        if (valorInput) {
          valorInput.dataset.raw = String(unit);
          valorInput.value = unit === 0 ? '' : formatMiles(unit);
        }
        actualizarTotalFila(tr);
        tbody.appendChild(tr);
      });
      if ((items || []).length === 0) {
        var tr0 = filaTabla();
        tr0.querySelector('input[name="valor"]').value = '';
        tr0.querySelector('input[name="valor"]').dataset.raw = '0';
        actualizarTotalFila(tr0);
        tbody.appendChild(tr0);
      }
    }

    function setDescuentosDesdeItems(items) {
      if (!discountsList) return;
      discountsList.innerHTML = '';
      (items || []).forEach(function(d) {
        var row = crearDescuentoRow();
        var montoInput = row.querySelector('.descuento-monto');
        var motivoInput = row.querySelector('.descuento-motivo');
        var monto = parseInt(d && d.monto, 10);
        if (isNaN(monto) || monto < 0) monto = 0;
        if (montoInput) {
          montoInput.dataset.raw = String(monto);
          montoInput.value = monto === 0 ? '' : formatMiles(monto);
        }
        if (motivoInput) motivoInput.value = String((d && d.motivo) || '').trim().toUpperCase();
        discountsList.appendChild(row);
      });
    }

    function applyOrden(orden) {
      // Un PDF puede no tener todos los campos: rellenamos lo que exista y lo demás queda vacío.
      orden = orden && typeof orden === 'object' ? orden : {};

      function setValueById(id, value) {
        var el = document.getElementById(id);
        if (!el) return;
        el.value = String(value || '').trim().toUpperCase();
      }

      setValueById('presupuesto-num', orden.presupuestoNumero);

      var c = (orden && orden.cliente) || {};
      setValueById('cliente-nombre', c.nombre);
      setValueById('cliente-rut', c.rut);
      setValueById('cliente-fono', c.fono);
      var fechaIso = String(c.fechaIso || '').trim();
      if (fechaIso) setValueById('cliente-fecha', fechaIso);

      var v = (orden && orden.vehiculo) || {};
      setValueById('vehiculo-patente', v.patente);
      setValueById('vehiculo-ano', v.ano);
      setValueById('vehiculo-marca', v.marca);
      setValueById('vehiculo-modelo', v.modelo);
      setValueById('vehiculo-vin', v.vin);
      // Combustible (radios)
      var comb = String(v.combustible || '').trim().toUpperCase();
      document.querySelectorAll('input[name="vehiculo-combustible"]').forEach(function(r) {
        r.checked = comb && String(r.value || '').toUpperCase() === comb;
      });
      setValueById('vehiculo-color', v.color);

      var kmInput = document.getElementById('vehiculo-kilometraje');
      if (kmInput) {
        var kmRaw = String(v.kilometraje || '').replace(/\D/g, '');
        if (!kmRaw) {
          kmInput.dataset.raw = '';
          kmInput.value = '';
        } else {
          kmInput.dataset.raw = kmRaw;
          kmInput.value = formatMiles(kmRaw);
        }
      }

      setTablaDesdeItems(bodyRepuestos, Array.isArray(orden.repuestos) ? orden.repuestos : []);
      setTablaDesdeItems(bodyMano, Array.isArray(orden.manoDeObra) ? orden.manoDeObra : []);
      setDescuentosDesdeItems(Array.isArray(orden.descuentos) ? orden.descuentos : []);
      setMoneyInput(abonoMontoInput, orden.abonoMonto || 0);
      if (notaInput) notaInput.value = String(orden.nota || '').trim();
      actualizarTotalPreview();
    }

    if (btnRetomar && fileRetomar) {
      btnRetomar.addEventListener('click', function() {
        message.innerHTML = '';
        fileRetomar.value = '';
        fileRetomar.click();
      });
      fileRetomar.addEventListener('change', async function() {
        var file = fileRetomar.files && fileRetomar.files[0];
        if (!file) return;
        if (!/\.pdf$/i.test(file.name) && file.type !== 'application/pdf') {
          showMessage('Seleccione un archivo PDF generado por el sistema.', true);
          return;
        }
        btnRetomar.disabled = true;
        btnPdf.disabled = true;
        try {
          var buf = await file.arrayBuffer();
          var b64 = arrayBufferToBase64(buf);
          var res = await fetch(window.location.origin + '/.netlify/functions/restore-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pdfBase64: b64 }),
          });
          if (!res.ok) {
            var err = await res.json().catch(function() { return {}; });
            throw new Error(err.error || err.detail || 'No se pudo retomar la orden.');
          }
          var json = await res.json();
          applyOrden(json.orden || json);
          // Marcar que la última acción fue retomar, para NO autoincrementar desde ese número
          try { localStorage.setItem(LS_SKIP_NEXT_INCREMENT, '1'); } catch (_) {}
          showMessage('Orden retomada correctamente.', false);
        } catch (e) {
          showMessage(e.message || 'No se pudo retomar la orden.', true);
        } finally {
          btnRetomar.disabled = false;
          btnPdf.disabled = false;
        }
      });
    }

    function logoToBase64() {
      return fetch(window.location.origin + '/logo-pdf.jpeg')
        .then(function(r) { return r.blob(); })
        .then(function(blob) {
          return new Promise(function(resolve, reject) {
            var reader = new FileReader();
            reader.onload = function() {
              var dataUrl = reader.result;
              var b64 = dataUrl.split(',')[1];
              resolve(b64 || '');
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        })
        .catch(function() { return ''; });
    }

    btnPdf.addEventListener('click', async function() {
      message.innerHTML = '';
      var repuestos = leerFilas(bodyRepuestos);
      var manoDeObra = leerFilas(bodyMano);
      if (repuestos.length === 0 && manoDeObra.length === 0) {
        showMessage('Añada al menos una fila en Repuestos o Mano de Obra.', true);
        return;
      }
      btnPdf.disabled = true;
      try {
        var logo = await logoToBase64();
        var descuentos = leerDescuentos();
        var abonoMonto = abonoMontoInput && abonoMontoInput.dataset.raw !== undefined ? parseInt(abonoMontoInput.dataset.raw, 10) : 0;
        if (isNaN(abonoMonto) || abonoMonto < 0) abonoMonto = 0;
        var nota = notaInput ? notaInput.value.trim() : '';
        var fechaIso = (document.getElementById('cliente-fecha') || {}).value || '';
        var kmInput = document.getElementById('vehiculo-kilometraje');
        var kmRaw = kmInput && kmInput.dataset.raw !== undefined ? String(kmInput.dataset.raw) : '';
        var res = await fetch(window.location.origin + '/.netlify/functions/generate-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            repuestos: repuestos,
            manoDeObra: manoDeObra,
            cliente: leerCliente(),
            vehiculo: leerVehiculo(),
            presupuestoNumero: document.getElementById('presupuesto-num').value.trim(),
            descuentos: descuentos,
            abonoMonto: abonoMonto,
            nota: nota || undefined,
            orden: {
              version: 1,
              presupuestoNumero: document.getElementById('presupuesto-num').value.trim(),
              cliente: {
                nombre: document.getElementById('cliente-nombre').value.trim().toUpperCase(),
                fechaIso: String(fechaIso || '').trim(),
                rut: document.getElementById('cliente-rut').value.trim().toUpperCase(),
                fono: document.getElementById('cliente-fono').value.trim().toUpperCase(),
              },
              vehiculo: {
                patente: document.getElementById('vehiculo-patente').value.trim().toUpperCase(),
                ano: document.getElementById('vehiculo-ano').value.trim().toUpperCase(),
                marca: document.getElementById('vehiculo-marca').value.trim().toUpperCase(),
                modelo: document.getElementById('vehiculo-modelo').value.trim().toUpperCase(),
                kilometraje: String(kmRaw || '').trim(),
                vin: document.getElementById('vehiculo-vin').value.trim().toUpperCase(),
                combustible: (document.querySelector('input[name="vehiculo-combustible"]:checked') || {}).value || '',
                color: document.getElementById('vehiculo-color').value.trim().toUpperCase(),
              },
              repuestos: repuestos.map(function(r) { return { descripcion: r.descripcion, cantidad: r.cantidad, valorUnitario: r.valorUnitario }; }),
              manoDeObra: manoDeObra.map(function(m) { return { descripcion: m.descripcion, cantidad: m.cantidad, valorUnitario: m.valorUnitario }; }),
              descuentos: descuentos,
              abonoMonto: abonoMonto,
              nota: nota || '',
            },
            logo: logo || undefined,
          }),
        });
        if (!res.ok) {
          var err = await res.json().catch(function() { return {}; });
          throw new Error(err.error || err.detail || 'Error al generar el PDF');
        }
        var blob = await res.blob();
        var vehiculo = leerVehiculo();
        var marca = (vehiculo.marca || '').trim().replace(/[/\\:*?"<>|]/g, '') || 'Marca';
        var modelo = (vehiculo.modelo || '').trim().replace(/[/\\:*?"<>|]/g, '') || 'Modelo';
        var filename = 'Presupuesto ' + marca + ' ' + modelo + '.pdf';
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        // Guardar último presupuesto generado para sugerir el siguiente
        try {
          var p = document.getElementById('presupuesto-num');
          var val = p ? String(p.value || '').trim() : '';
          if (val) localStorage.setItem(LS_LAST_PRESUPUESTO, val);
          localStorage.removeItem(LS_SKIP_NEXT_INCREMENT);
        } catch (_) {}
        showMessage('PDF generado correctamente.', false);
      } catch (err) {
        showMessage(err.message || 'Error al generar el PDF.', true);
      } finally {
        btnPdf.disabled = false;
      }
    });
  </script>
</body>
</html>
